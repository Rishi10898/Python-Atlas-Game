<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOLT - Multiplayer Tag Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Black', Arial, sans-serif;
            overflow: hidden;
            user-select: none;
        }

        .screen {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
        }

        .hidden {
            display: none !important;
        }

        /* Menu Screen */
        #menuScreen {
            background: linear-gradient(to bottom, #60A5FA, #93C5FD);
        }

        #menuScreen h1 {
            font-size: 8rem;
            color: white;
            text-shadow: 8px 8px 0px rgba(0,0,0,0.2);
            letter-spacing: 16px;
            margin-bottom: 80px;
        }

        .menu-box {
            background: #EC4899;
            padding: 60px;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .menu-btn {
            width: 400px;
            padding: 24px;
            font-size: 2rem;
            font-weight: 900;
            color: white;
            border: none;
            border-radius: 16px;
            margin-bottom: 24px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .menu-btn:hover {
            transform: scale(1.05);
        }

        .btn-1player, .btn-2player {
            background: linear-gradient(to right, #EF4444, #DC2626);
        }

        .btn-3player {
            background: linear-gradient(to right, #FBBF24, #F59E0B);
        }

        .btn-4player {
            background: linear-gradient(to right, #10B981, #059669);
        }

        .sound-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Map Select Screen */
        #mapScreen {
            background: linear-gradient(to bottom, #22D3EE, #67E8F9);
        }

        #mapScreen h1 {
            font-size: 5rem;
            color: white;
            text-shadow: 6px 6px 0px rgba(0,0,0,0.2);
            margin-bottom: 80px;
        }

        .map-container {
            display: flex;
            gap: 40px;
            margin-bottom: 60px;
        }

        .map-option {
            width: 320px;
            height: 220px;
            border-radius: 24px;
            border: 4px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .map-option:hover {
            transform: scale(1.05);
        }

        .map-magical {
            background: linear-gradient(to bottom, #60A5FA, #EC4899);
        }

        .map-winter {
            background: linear-gradient(to bottom, #BFDBFE, #DBEAFE);
        }

        .map-desert {
            background: linear-gradient(to bottom, #FCD34D, #FB923C);
        }

        .map-option span {
            font-size: 2rem;
            font-weight: 900;
            z-index: 10;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .back-btn {
            position: absolute;
            top: 24px;
            left: 24px;
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            border: 4px solid #0891B2;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .settings-btn {
            background: white;
            color: #0891B2;
            padding: 16px 60px;
            font-size: 1.5rem;
            font-weight: 900;
            border: 4px solid #0891B2;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .settings-btn:hover {
            transform: scale(1.05);
        }

        /* Controls Screen */
        #controlsScreen {
            background: linear-gradient(to bottom, #2DD4BF, #5EEAD4);
        }

        #controlsScreen h1 {
            font-size: 5rem;
            color: white;
            text-shadow: 6px 6px 0px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        #controlsScreen p {
            color: white;
            font-size: 1.2rem;
            margin-bottom: 60px;
            font-weight: bold;
        }

        .controls-container {
            display: flex;
            gap: 32px;
            margin-bottom: 60px;
        }

        .player-control {
            position: relative;
            width: 260px;
        }

        .player-label {
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 32px;
            border-radius: 24px;
            color: white;
            font-weight: 900;
            font-size: 1.2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .control-box {
            background: rgba(75, 85, 99, 0.8);
            padding: 32px;
            border-radius: 24px;
            border: 4px solid;
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
        }

        .character-preview {
            background: rgba(107, 114, 128, 0.6);
            border-radius: 16px;
            padding: 24px;
            height: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .character {
            width: 64px;
            height: 80px;
            border-radius: 6px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .character-face {
            width: 40px;
            height: 40px;
            background: black;
            border-radius: 50%;
            position: relative;
        }

        .character-eye {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 12px;
        }

        .eye-left {
            left: 8px;
        }

        .eye-right {
            right: 8px;
        }

        .keys-row {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .key-box {
            width: 64px;
            height: 64px;
            border: 4px solid white;
            border-radius: 8px;
            background: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 900;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .control-label {
            text-align: center;
            padding: 12px;
            border-radius: 24px;
            color: white;
            font-weight: 900;
            font-size: 1.1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .start-btn {
            background: white;
            color: #0D9488;
            padding: 24px 100px;
            font-size: 3rem;
            font-weight: 900;
            border: 4px solid #0D9488;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
        }

        .start-btn:hover {
            transform: scale(1.05);
        }

        /* Game Screen */
        #gameScreen {
            background: #1F2937;
        }

        .game-header {
            display: flex;
            gap: 32px;
            margin-bottom: 20px;
        }

        .timer {
            color: white;
            font-size: 2rem;
            font-weight: 900;
            background: #374151;
            padding: 16px 32px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .quit-btn {
            background: #EF4444;
            color: white;
            padding: 16px 40px;
            font-size: 1.5rem;
            font-weight: 900;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .quit-btn:hover {
            background: #DC2626;
        }

        #gameCanvas {
            border: 8px solid white;
            border-radius: 8px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.5);
        }

        .scores {
            display: flex;
            gap: 32px;
            background: #374151;
            padding: 20px 40px;
            border-radius: 12px;
            margin-top: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .score-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .score-color {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .score-text {
            color: white;
            font-size: 1.2rem;
            font-weight: 900;
        }

        .star {
            color: #FCD34D;
            font-size: 2rem;
        }

        .teleport-status {
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <!-- Menu Screen -->
    <div id="menuScreen" class="screen">
        <div class="sound-icon" onclick="toggleSound()">
            <span id="soundIcon">🔊</span>
        </div>
        <h1>TAG</h1>
        <div class="menu-box">
            <button class="menu-btn btn-1player" onclick="selectPlayers(1)">1 PLAYER</button>
            <button class="menu-btn btn-2player" onclick="selectPlayers(2)">2 PLAYERS</button>
            <button class="menu-btn btn-3player" onclick="selectPlayers(3)">3 PLAYERS</button>
            <button class="menu-btn btn-4player" onclick="selectPlayers(4)">4 PLAYERS</button>
        </div>
    </div>

    <!-- Map Select Screen -->
    <div id="mapScreen" class="screen hidden">
        <button class="back-btn" onclick="showScreen('menuScreen')">←</button>
        <h1>CHOOSE MAP</h1>
        <div class="map-container">
            <div class="map-option map-magical" onclick="selectMap('Magical')">
                <span style="color: white;">MAGICAL</span>
            </div>
            <div class="map-option map-winter" onclick="selectMap('Winter')">
                <span style="color: #374151;">WINTER</span>
            </div>
            <div class="map-option map-desert" onclick="selectMap('Desert')">
                <span style="color: white;">DESERT</span>
            </div>
        </div>
        <button class="settings-btn" onclick="showScreen('menuScreen')">GAME SETTINGS</button>
    </div>

    <!-- Controls Screen -->
    <div id="controlsScreen" class="screen hidden">
        <button class="back-btn" onclick="showScreen('mapScreen')" style="border-color: #0D9488;">↓</button>
        <h1>CONTROLS</h1>
        <p>MAKE SURE THAT THE KEYBOARD ONLY SUPPORTS KEYSTROKES</p>
        <div id="controlsContainer" class="controls-container"></div>
        <button class="start-btn" onclick="startGame()">START</button>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen hidden">
        <div class="game-header">
            <div class="timer">TIME: <span id="timer">60</span>s</div>
            <button class="quit-btn" onclick="showScreen('menuScreen')">QUIT</button>
        </div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="scoresContainer" class="scores"></div>
        <div class="teleport-status" id="teleportStatus">🌀 Teleport Ready!</div>
    </div>

    <script>
        // Game state
        let gameState = {
            numPlayers: 2,
            selectedMap: null,
            players: [],
            tagger: 0,
            scores: [0, 0, 0, 0],
            roundTime: 60,
            teleportUsed: false,
            soundEnabled: true,
            keysPressed: {}
        };

        const playerConfigs = [
            { color: '#E74C3C', name: 'RED', keys: { left: 'KeyA', right: 'KeyD', up: 'KeyW' }, displayKeys: ['W', 'A', 'D'] },
            { color: '#3498DB', name: 'BLUE', keys: { left: 'ArrowLeft', right: 'ArrowRight', up: 'ArrowUp' }, displayKeys: ['↑', '←', '→'] },
            { color: '#F1C40F', name: 'YELLOW', keys: { left: 'KeyJ', right: 'KeyL', up: 'KeyI' }, displayKeys: ['I', 'J', 'L'] },
            { color: '#2ECC71', name: 'GREEN', keys: { left: 'KeyF', right: 'KeyH', up: 'KeyT' }, displayKeys: ['T', 'F', 'H'] }
        ];

        const maps = {
            Magical: {
                bg: '#5BA3E8',
                groundColor: '#FF1B8D',
                groundTop: '#4CAF50',
                platforms: [
                    { x: 0, y: 520, w: 800, h: 80 },
                    { x: 80, y: 440, w: 120, h: 15 },
                    { x: 280, y: 380, w: 100, h: 15 },
                    { x: 450, y: 330, w: 150, h: 15 },
                    { x: 150, y: 280, w: 100, h: 15 },
                    { x: 500, y: 220, w: 120, h: 15 },
                    { x: 650, y: 440, w: 130, h: 15 }
                ],
                obstacles: [
                    { x: 350, y: 470, w: 40, h: 50 },
                    { x: 600, y: 360, w: 50, h: 60 }
                ],
                bouncePads: [
                    { x: 220, y: 510, w: 60, h: 12 },
                    { x: 550, y: 510, w: 60, h: 12 },
                    { x: 400, y: 320, w: 60, h: 12 }
                ],
                teleport: { x: 100, y: 200, size: 35 }
            },
            Winter: {
                bg: '#A8D8EA',
                groundColor: '#E8F4F8',
                groundTop: '#FFFFFF',
                platforms: [
                    { x: 0, y: 520, w: 800, h: 80 },
                    { x: 100, y: 450, w: 110, h: 15 },
                    { x: 300, y: 390, w: 90, h: 15 },
                    { x: 480, y: 340, w: 140, h: 15 },
                    { x: 180, y: 290, w: 110, h: 15 },
                    { x: 520, y: 230, w: 100, h: 15 },
                    { x: 600, y: 450, w: 140, h: 15 }
                ],
                obstacles: [
                    { x: 250, y: 460, w: 35, h: 60 },
                    { x: 650, y: 370, w: 45, h: 80 }
                ],
                bouncePads: [
                    { x: 50, y: 510, w: 60, h: 12 },
                    { x: 430, y: 510, w: 60, h: 12 },
                    { x: 320, y: 330, w: 60, h: 12 }
                ],
                teleport: { x: 700, y: 180, size: 35 }
            },
            Desert: {
                bg: '#FFD54F',
                groundColor: '#F4A460',
                groundTop: '#FFE4B5',
                platforms: [
                    { x: 0, y: 520, w: 800, h: 80 },
                    { x: 70, y: 460, w: 130, h: 15 },
                    { x: 270, y: 400, w: 110, h: 15 },
                    { x: 460, y: 350, w: 160, h: 15 },
                    { x: 160, y: 300, w: 100, h: 15 },
                    { x: 490, y: 240, w: 130, h: 15 },
                    { x: 630, y: 460, w: 150, h: 15 }
                ],
                obstacles: [
                    { x: 380, y: 455, w: 50, h: 65 },
                    { x: 580, y: 365, w: 40, h: 75 }
                ],
                bouncePads: [
                    { x: 210, y: 510, w: 60, h: 12 },
                    { x: 580, y: 510, w: 60, h: 12 },
                    { x: 370, y: 340, w: 60, h: 12 }
                ],
                teleport: { x: 400, y: 180, size: 35 }
            }
        };

        // Utility functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            document.getElementById('soundIcon').textContent = gameState.soundEnabled ? '🔊' : '🔇';
        }

        function playSound(type) {
            if (!gameState.soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'tag') {
                    oscillator.frequency.value = 523;
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.15);
                } else if (type === 'teleport') {
                    oscillator.frequency.value = 880;
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.4);
                } else if (type === 'bounce') {
                    oscillator.frequency.value = 330;
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                }
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function selectPlayers(num) {
            gameState.numPlayers = num;
            showScreen('mapScreen');
        }

        function selectMap(mapName) {
            gameState.selectedMap = mapName;
            showControlsScreen();
        }

        function showControlsScreen() {
            const container = document.getElementById('controlsContainer');
            container.innerHTML = '';
            
            for (let i = 0; i < gameState.numPlayers; i++) {
                const config = playerConfigs[i];
                const controlDiv = document.createElement('div');
                controlDiv.className = 'player-control';
                controlDiv.innerHTML = `
                    <div class="player-label" style="background-color: ${config.color}">${config.name}</div>
                    <div class="control-box" style="border-color: ${config.color}">
                        <div class="character-preview">
                            <div class="character" style="background-color: ${config.color}">
                                <div class="character-face">
                                    <div class="character-eye eye-left"></div>
                                    <div class="character-eye eye-right"></div>
                                </div>
                            </div>
                        </div>
                        <div class="keys-row">
                            <div class="key-box">${config.displayKeys[1]}</div>
                            <div class="key-box">${config.displayKeys[0]}</div>
                            <div class="key-box">${config.displayKeys[2]}</div>
                        </div>
                        <div class="control-label" style="background-color: ${config.color}">CONTROL</div>
                    </div>
                `;
                container.appendChild(controlDiv);
            }
            
            showScreen('controlsScreen');
        }

        function drawCharacter(ctx, x, y, width, height, color) {
            // Body
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.roundRect(x, y, width, height, 5);
            ctx.fill();
            
            // Face
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(x + width/2, y + height/2, 12, 0, Math.PI * 2);
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(x + width/2 - 5, y + height/2 - 2, 3, 0, Math.PI * 2);
            ctx.arc(x + width/2 + 5, y + height/2 - 2, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // Ears
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x + width/2 - 10, y + 3);
            ctx.lineTo(x + width/2 - 6, y - 8);
            ctx.lineTo(x + width/2 - 2, y + 3);
            ctx.closePath();
            ctx.fill();
            
            ctx.beginPath();
            ctx.moveTo(x + width/2 + 2, y + 3);
            ctx.lineTo(x + width/2 + 6, y - 8);
            ctx.lineTo(x + width/2 + 10, y + 3);
            ctx.closePath();
            ctx.fill();
            
            // Accent
            ctx.fillStyle = color;
            ctx.fillRect(x + width/2 + 8, y + height/2 + 2, 6, 10);
        }

        function initializePlayers() {
            const startPositions = [
                { x: 50, y: 400 },
                { x: 750, y: 400 },
                { x: 200, y: 400 },
                { x: 600, y: 400 }
            ];
            
            gameState.players = [];
            for (let i = 0; i < gameState.numPlayers; i++) {
                gameState.players.push({
                    x: startPositions[i].x,
                    y: startPositions[i].y,
                    vx: 0,
                    vy: 0,
                    width: 30,
                    height: 38,
                    onGround: false,
                    config: playerConfigs[i],
                    isAI: i === 1 && gameState.numPlayers === 1,
                    aiTimer: 0,
                    aiAction: 0
                });
            }
            
            gameState.tagger = Math.floor(Math.random() * gameState.numPlayers);
            gameState.teleportUsed = false;
            gameState.roundTime = 60;
        }

        function updateScores() {
            const container = document.getElementById('scoresContainer');
            container.innerHTML = '';
            
            gameState.players.forEach((player, idx) => {
                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'score-item';
                scoreDiv.innerHTML = `
                    <div class="score-color" style="background-color: ${player.config.color}"></div>
                    <span class="score-text">${player.config.name}: ${gameState.scores[idx]}</span>
                    ${idx === gameState.tagger ? '<span class="star">★</span>' : ''}
                `;
                container.appendChild(scoreDiv);
            });
            
            document.getElementById('teleportStatus').textContent = 
                gameState.teleportUsed ? '⚠️ Teleport Used' : '🌀 Teleport Ready!';
        }

        let animationId = null;
        let lastTime = 0;
        let timerInterval = null;

        function startGame() {
            initializePlayers();
            updateScores();
            showScreen('gameScreen');
            
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const map = maps[gameState.selectedMap];
            
            lastTime = performance.now();
            
            // Timer
            document.getElementById('timer').textContent = gameState.roundTime;
            timerInterval = setInterval(() => {
                gameState.roundTime--;
                document.getElementById('timer').textContent = gameState.roundTime;
                if (gameState.roundTime <= 0) {
                    clearInterval(timerInterval);
                    cancelAnimationFrame(animationId);
                    showScreen('menuScreen');
                }
            }, 1000);
            
            function gameLoop(currentTime) {
                const deltaTime = Math.min((currentTime - lastTime) / 1000, 0.05);
                lastTime = currentTime;
                
                const gravity = 1200;
                const moveSpeed = 200;
                const jumpForce = 450;
                const airControl = 0.7;
                
                // Update players
                gameState.players.forEach((player, idx) => {
                    // AI
                    if (player.isAI) {
                        player.aiTimer -= deltaTime;
                        if (player.aiTimer <= 0) {
                            player.aiTimer = Math.random() * 0.5 + 0.3;
                            player.aiAction = Math.floor(Math.random() * 5);
                        }
                        
                        const target = gameState.players[gameState.tagger];
                        if (idx === gameState.tagger) {
                            let nearest = null;
                            let minDist = Infinity;
                            gameState.players.forEach((p, i) => {
                                if (i !== idx) {
                                    const dist = Math.abs(p.x - player.x);
                                    if (dist < minDist) {
                                        minDist = dist;
                                        nearest = p;
                                    }
                                }
                            });
                            if (nearest) {
                                if (nearest.x < player.x - 30) player.vx = -moveSpeed * airControl;
                                else if (nearest.x > player.x + 30) player.vx = moveSpeed * airControl;
                                else player.vx =
